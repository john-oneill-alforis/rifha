{% extends 'base.html' %}



{% block content %}
{% load humanize %}
  


<main>
    <div class="container col-lg-9">
        <div class="justify-content-between pt-3 pb-2 border-bottom">
            <p class="display-6">Program Overview</p>
        </div>

        <div class="row pt-1" >
            <div class="col border m-1 mb-0 p-2 bg-secondary text-dark bg-opacity-25 text-center">
                <p class="h4">Controls  <i class="bi bi-speedometer text-success"></i></p>
            </div>
            <div class="col border m-1 mb-0 p-2 bg-secondary text-dark bg-opacity-25 text-center">
                <p class="h4">Processes  <i class="bi bi-briefcase-fill text-primary"></i></p>
            </div>
            <div class="col border m-1 mb-0 p-2 bg-secondary text-dark bg-opacity-25  text-center">
                <p class="h4">Risk Owners  <i class="bi bi-people-fill text-warning"></i></p>
            </div>
            <div class="col border m-1 mb-0 p-2 bg-secondary text-dark bg-opacity-25 text-center">
                <p class="h4">Assets <i class="bi bi-laptop text-info"></i></p>
            </div>
        </div>

        <div class="row">
            <div class="col p-2 m-1 mt-0 text-center border border-top-0" style="height: 125px; display: flex; justify-content: center; align-items: center;">
                <p class="h3">{{controlCount}}</p>
            </div>
            <div class="col p-2 m-1 mt-0 text-center border border-top-0" style="height: 125px; display: flex; justify-content: center; align-items: center;">
                <p class="h3">{{processCount}}</p>
            </div>
            <div class="col p-2 m-1 mt-0 text-center border border-top-0" style="height: 125px; display: flex; justify-content: center; align-items: center;">
                <p class="h3">{{riskOwners}}</p>
            </div>
            <div class="col p-2 m-1 mt-0 text-center border border-top-0" style="height: 125px; display: flex; justify-content: center; align-items: center;">
                <p class="h3">{{assetCount}}</p>
            </div>
        </div>

        <div class="row pt-1" >
            <div class="col border m-1 mb-0 p-2 bg-secondary text-dark bg-opacity-25 text-center">
                <p class="h4">Risk Owner Total Residual Valuations</p>
            </div>
        </div>

        <div class="row">
            <div class="col h-10 p-2 m-1 mt-0 text-center border border-top-0" style="height: 350px; display: flex; justify-content: center; align-items: center;">
                <canvas id="myChart"></canvas>

                <script>
                    // Sample data for the chart
                    const data = {
                    labels: [{% for x in riskOwnersRValue %}"{{ x.riskOwner__fullName }}",{% endfor %}],
                    datasets: [
                        {
                        label: "Inherent Max Value",
                        data: [{% for x in riskOwnersIValue %}{{ x.totalMaxInherent | floatformat:2 }},{% endfor %}],
                        borderWidth: 1,
                        backgroundColor: [
                                            'rgb(7,43,81)',
                                            
                                    ],
                        },
                        {
                        label: "Residual Max Value",
                        data: [{% for x in  riskOwnersRValue %}{{ x.totalMaxResidual | floatformat:2 }},{% endfor %}],
                        borderWidth: 1,
                        backgroundColor: [
                                            'rgb(129,174,208)',
                                    ],
                        },
                    ],
                    };
                    Chart.register(ChartDataLabels);

                    function formatNumberAsCurrency(value) {
                        // Convert the number to a string with two decimal places
                        const formattedNumber = value.toFixed(2);
                      
                        // Add commas as thousand separators
                        const parts = formattedNumber.split('.');
                        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                      
                        // Join the parts back together with a dot as the decimal separator and add the euro symbol
                        return '€' + parts.join('.');
                        }
                      
                    const config = {
                    type: "bar",
                    data: data,
                    options: {
                        responsive: true,
                        scales: {
                        y: {
                            beginAtZero: true,
                        },
                        },
                        plugins: {
                        legend: {
                            display: true,
                        },
                        datalabels: { // This code is used to display data values
                            anchor: 'end',
                            align: 'top',
                            formatter: formatNumberAsCurrency,
                            font: {
                                weight: 'normal',
                                size: 10
                            }
                        }
                        },
                    },
                    };

                    // Create the chart
                    const ctx = document.getElementById("myChart").getContext("2d");
                    const myChart = new Chart(ctx, config);
                </script>
                
            </div>
        </div>

        <div class="row pt-1" >
            <div class="col border m-1 mb-0 p-2 bg-secondary text-dark bg-opacity-25 text-center">
                <p class="h4">Assessments Completed <i class="bi bi-clipboard-check-fill text-info"></i></p>
            </div>
    
            <div class="col border m-1 mb-0 p-2 bg-secondary text-dark bg-opacity-25 text-center">
                <p class="h4">Process Categories <i class="bi bi-briefcase-fill text-primary"></i></p>
            </div>
        </div>

      

        <div class="row">
            <div class="col p-2 m-1 mt-0 text-center border border-top-0 d-flex justify-content-center" style="height: 350px;">
                <canvas id="errorTotalCount"></canvas>
                <script>
                        const ctx_errorCount = document.getElementById('errorTotalCount').getContext('2d');
                        const labelCount = new Chart(ctx_errorCount, {
                            type: 'doughnut',
                            data: {
                                labels : ["Complete","Incomplete"],
                                datasets: [{
                                    label: "% Assessments Completed",
                                    data : [{{completionPercentage}},{{incompletePercentage}}],
                                    hoverOffset: 4,
                                    borderWidth: 1,
                                    backgroundColor: [
                                                    'rgb(31, 63, 73)',
                                                    'rgb(106, 177, 135)',
                                    ],
                                }]
                            },
                            options: {
                                responsive: true, 
                                scales: {
                                 x: {
                                   display: false, 
                                   grid: {
                                     display: false,
                                     
                                   }
                                 },
                                 y: {
                                display: false,
                                   grid: {
                                     display: false
                                   }
                                 }
                               }
                             }
                        });
                </script>
            </div>
            
            <div class="col p-2 m-1 mt-0 text-center border border-top-0" style="height: 350px;  display: flex; justify-content: center; align-items: center;">
                <canvas id="processCategories"></canvas>
                <script>
                        const ctx_processCategories = document.getElementById('processCategories').getContext('2d');
                        const processCategories = new Chart(ctx_processCategories, {
                            type: 'doughnut',
                            data: {
                                
                                labels : [{% for x in criticalityCounts %}"{{ x.businessProcessCriticality }}",{% endfor %}],
                                datasets: [{
                                    label: "Category Count",
                                    data : [{% for x in criticalityCounts %}"{{ x.count }}",{% endfor %}],
                                    borderWidth: 1,
                                    hoverOffset: 4,
                                    backgroundColor: [
                                                    'rgb(126, 144, 154)',
                                                    'rgb(234, 106, 71)',
                                                    'rgb(28, 78, 128)',
                                                    'rgb(0, 145, 213)',
                                    ],
                                }]
                            },
                            options: {  
                                responsive: true,                         
                                scales: {
                                 x: {
                                   display: false, 
                                   grid: {
                                     display: false,
                                   }
                                 },
                                 y: {
                                display: false,
                                   grid: {
                                     display: false
                                   }
                                 }
                               }
                             }
                        });
                </script>
               
            </div>
        </div>

        <div class="row pt-1">    
            <div class="col border mb-1 bg-secondary text-dark bg-opacity-25 text-center"><p class="h5">Risk Ref</p></div>
            <div class="col border mb-1 bg-secondary text-dark bg-opacity-25 text-center"><p class="h5">Risk Owner</p></div>
            <div class="col border mb-1 bg-secondary text-dark bg-opacity-25 text-center"><p class="h5">Asset</p></div>
            <div class="col border mb-1 bg-secondary text-dark bg-opacity-25 text-center"><p class="h5">Data Classification</p></div>
            <div class="col border mb-1 bg-secondary text-dark bg-opacity-25 text-center"><p class="h5">Max Residual</p></div>
        </div>
       
        {% for entry in riskData%}
        <div class="row">    
            <div class="col mb-1"><a href="riskEdit/{{entry.riskId}}/">{{entry.riskId | truncatechars:16}}</a></div>
            <div class="col mb-3 text-center">{{entry.riskOwner__fullName}}</div>
            <div class="col mb-3 text-center">{{entry.riskAsset__assetName}}</div>
            <div class="col mb-3 text-center">{{entry.riskAsset__assetClassification__classificationLabel}}</div>
            
            {% if entry.riskAssessmentStatus == 1%}
            <div class="col mb-3 text-center">€{{entry.maxResidual| floatformat:2 | intcomma}}</div>
                {% else %}
            <div class="col mb-3 bg-warning bg-danger-75 text-center">Assessment Incomplete</div>
            {% endif %}
            
        </div>
        {% endfor %}

    </div>           
</main>
{% endblock %}